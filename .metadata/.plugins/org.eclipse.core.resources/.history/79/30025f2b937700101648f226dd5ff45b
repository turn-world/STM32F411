/*
 * sd.c
 *
 *  Created on: Aug 10, 2025
 *      Author: young
 */


#include "sd.h"
#include "gpio.h"
#include "cli.h"

static bool is_init = false;
// init이 되었느냐
static bool is_detected = false;

SD_HandleTypeDef hsd;
DMA_HandleTypeDef hdma_sdio_rx;
DMA_HandleTypeDef hdma_sdio_tx;

bool sdInit(void)
{
	bool ret = false;

	  hsd.Instance 					= SDIO;
	  hsd.Init.ClockEdge 			= SDIO_CLOCK_EDGE_RISING;
	  hsd.Init.ClockBypass 			= SDIO_CLOCK_BYPASS_DISABLE;
	  hsd.Init.ClockPowerSave 		= SDIO_CLOCK_POWER_SAVE_DISABLE;
	  hsd.Init.BusWide 				= SDIO_BUS_WIDE_1B;
	  hsd.Init.HardwareFlowControl 	= SDIO_HARDWARE_FLOW_CONTROL_DISABLE;
	  hsd.Init.ClockDiv 			= SDIO_TRANSFER_CLK_DIV;

	  is_detected = false;
	  if (gpioPinRead(_PIN_GPIO_SDCARD_DETECT) == true)
	  {
	    is_detected = true;
	  }

	  if(is_detected == true)
	  {
		  if (HAL_SD_Init(&hsd) == HAL_OK)
		      {
		        if (HAL_SD_ConfigWideBusOperation(&hsd, SDIO_BUS_WIDE_4B) == HAL_OK)
		        {
		          ret = true;
		        }
		      }
	  }


	  if (HAL_SD_Init(&hsd) != HAL_OK)
	  {
	    Error_Handler();
	  }
	  if (HAL_SD_ConfigWideBusOperation(&hsd, SDIO_BUS_WIDE_4B) != HAL_OK)
	  {
	    Error_Handler();
	  }

	return ret;
}
